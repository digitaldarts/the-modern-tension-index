<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Modern Tension Index 2025 — World Map</title>
<script src="https://unpkg.com/d3@7"></script>
<script src="https://unpkg.com/topojson@3"></script>
<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #fff;
  }
  svg {
    width: 100%;
    height: 820px;
    display: block;
  }
  .tooltip {
    position: absolute;
    background: rgba(0,0,0,0.75);
    color: #fff;
    padding: 6px 10px;
    border-radius: 4px;
    pointer-events: none;
    font-size: 13px;
    line-height: 1.4;
  }
</style>
</head>
<body>
<svg></svg>
<div class="tooltip" style="opacity:0;"></div>

<script>
(async function() {
  const csvUrl = "https://raw.githubusercontent.com/digitaldarts/the-modern-tension-index/main/modern_tension_index_2025.csv";
  const worldUrl = "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json";

  const svg = d3.select("svg");
  const tooltip = d3.select(".tooltip");
  const width = svg.node().clientWidth;
  const height = svg.node().clientHeight;

  const projection = d3.geoNaturalEarth1()
    .scale(width / 1.3 / Math.PI)
    .translate([width / 2, height / 2]);

  const path = d3.geoPath(projection);

  // color scale
  const color = d3.scaleSequential()
    .domain([0, 100])
    .interpolator(d3.interpolateRdYlBu.reverse());

  // Load data
  const [world, csv] = await Promise.all([
    d3.json(worldUrl),
    d3.csv(csvUrl)
  ]);

  // Clean & map data
  const dataMap = new Map(csv.map(d => [
    d.Country.trim().toLowerCase(),
    {
      tension: +d.Tension_Index_v1?.trim(),
      sleep: +d.Sleep_Hours?.trim(),
      screen: +d.Screen_Hours?.trim(),
      work: +d.Annual_Work_Hours?.trim()
    }
  ]));

  const countries = topojson.feature(world, world.objects.countries).features;

  const g = svg.append("g");

  // Draw countries
  g.selectAll("path")
    .data(countries)
    .join("path")
    .attr("d", path)
    .attr("fill", d => {
      const c = d.properties.name.toLowerCase();
      const val = dataMap.get(c)?.tension;
      return Number.isFinite(val) ? color(val) : "#eee";
    })
    .attr("stroke", "#ccc")
    .attr("stroke-width", 0.5)
    .on("mousemove", (event, d) => {
      const c = d.properties.name.toLowerCase();
      const match = dataMap.get(c);
      if (match) {
        tooltip
          .style("opacity", 1)
          .html(`
            <strong>${d.properties.name}</strong><br>
            Tension Index: ${match.tension.toFixed(1)} / 100<br>
            Sleep: ${match.sleep ? match.sleep.toFixed(1) + " h" : "–"}<br>
            Screen: ${match.screen ? match.screen.toFixed(1) + " h" : "–"}<br>
            Work: ${match.work ? Math.round(match.work) + " hrs/yr" : "–"}
          `)
          .style("left", (event.pageX + 12) + "px")
          .style("top", (event.pageY - 28) + "px");
      }
    })
    .on("mouseout", () => tooltip.style("opacity", 0));

  // Zoom / pan
  svg.call(
    d3.zoom()
      .scaleExtent([1, 8])
      .on("zoom", (event) => g.attr("transform", event.transform))
  );
})();
</script>
</body>
</html>
