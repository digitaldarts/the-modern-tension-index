<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Modern Tension Index 2025 — Interactive</title>
<meta name="description" content="Interactive choropleth map and ranking chart of the Modern Tension Index 2025, comparing countries by sleep, screen time, and annual work hours." />

<!-- D3 + TopoJSON (CDN) -->
<script src="https://unpkg.com/d3@7"></script>
<script src="https://unpkg.com/topojson-client@3"></script>

<style>
  :root {
    --bg: #ffffff;
    --panel: #f8f8f8;
    --border: #e5e5e5;
    --text: #222;
    --muted: #666;
  }
  html, body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; /* inherits well in iframe */
  }
  .wrap {
    max-width: 1200px;
    margin: 0 auto;
    padding: 18px;
  }
  .header {
    margin-bottom: 12px;
  }
  .header h1, .header h2, .header p {
    margin: 0 0 8px 0; /* do not override theme font sizes; just spacing */
  }
  .controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
    margin: 10px 0 18px 0;
  }
  .controls label {
    font-size: 0.95rem;
    color: var(--muted);
  }
  .grid {
    display: grid;
    grid-template-columns: 1.2fr 1fr;
    gap: 18px;
  }
  @media (max-width: 950px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }
  .card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
  }
  .legend {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 8px 0 6px 0;
    font-size: 0.9rem;
    color: var(--muted);
  }
  .legend-bar {
    height: 10px;
    flex: 1;
    background: linear-gradient(90deg, #2ecc71 0%, #f1c40f 50%, #e74c3c 100%); /* green->yellow->red */
    border-radius: 999px;
    border: 1px solid var(--border);
  }
  .svg-wrap {
    width: 100%;
    position: relative;
  }
  .tooltip {
    position: fixed;
    pointer-events: none;
    background: #111;
    color: #fff;
    font-size: 12.5px;
    padding: 8px 10px;
    border-radius: 6px;
    line-height: 1.4;
    opacity: 0;
    transition: opacity .15s ease;
    z-index: 10;
    max-width: 260px;
    box-shadow: 0 6px 24px rgba(0,0,0,0.18);
  }
  .rank-title {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin: 4px 0 8px 0;
    color: var(--muted);
    font-size: 0.95rem;
  }
  .row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 10px;
    align-items: center;
    margin: 6px 0;
  }
  .bar {
    height: 12px;
    border-radius: 6px;
    background: #ddd;
    position: relative;
    overflow: hidden;
  }
  .bar > span {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    background: linear-gradient(90deg, #2ecc71, #f1c40f, #e74c3c);
  }
  .row small {
    color: var(--muted);
  }
  .foot {
    margin-top: 8px;
    color: var(--muted);
    font-size: 0.9rem;
  }
  /* inputs */
  select, input[type="text"] {
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: #fff;
    font-size: 0.95rem;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>Modern Tension Index 2025</h1>
    <p>Interactive choropleth of <em>Tension_Index_v1</em> (0–100) by country, with Top-20 ranking. Higher = more tension (less sleep, more screen time, longer work hours).</p>
  </div>

  <div class="controls">
    <label>CSV:
      <input type="text" id="csvInput" size="48" placeholder="Paste CSV URL or add ?csv=URL to iframe src" />
    </label>
    <button id="loadBtn">Load</button>

    <label>Filter:
      <select id="regionSelect">
        <option value="All">All regions</option>
        <option value="Africa">Africa</option>
        <option value="Americas">Americas</option>
        <option value="Asia">Asia</option>
        <option value="Europe">Europe</option>
        <option value="Oceania">Oceania</option>
      </select>
    </label>

    <label>Show:
      <select id="countSelect">
        <option value="20">Top 20</option>
        <option value="40" selected>Top 40</option>
      </select>
    </label>
  </div>

  <div class="grid">
    <!-- MAP CARD -->
    <div class="card">
      <div class="legend">
        <span>Low</span>
        <div class="legend-bar"></div>
        <span>High</span>
      </div>
      <div class="svg-wrap">
        <svg id="map" viewBox="0 0 960 520" role="img" aria-label="World choropleth map"></svg>
      </div>
      <div class="foot">Hover the map for details. Click a country to pin its tooltip.</div>
    </div>

    <!-- RANKING CARD -->
    <div class="card">
      <div class="rank-title">
        <strong id="rankTitle">Top 20 by Tension Index</strong>
        <small id="rankSubtitle"></small>
      </div>
      <div id="rankList" aria-live="polite"></div>
      <div class="foot">Bars are colored on the same green→red scale as the map.</div>
    </div>
  </div>

  <p class="foot" style="margin-top:14px;">Data sources: WorldPopulationReview 2025, DataReportal 2025, OECD/ILO 2024.</p>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
(async function() {
  // ----- CONFIG -----
  // 1) Put your Shopify CSV file URL here:
  const CSV_URL = "REPLACE_WITH_YOUR_SHOPIFY_FILE_URL.csv"; // e.g., https://cdn.shopify.com/s/files/.../modern_tension_index_TOP40_complete.csv
  // 2) Optionally pass ?csv=URL in the iframe src to override:
  const paramCsv = new URLSearchParams(window.location.search).get("csv");
  const csvInputEl = document.getElementById("csvInput");
  const loadBtn = document.getElementById("loadBtn");
  csvInputEl.value = paramCsv || CSV_URL;

  // Lightweight region mapping for filtering (covers common names in your CSV)
  const REGION_BY_NAME = {
    // Africa
    "South Africa":"Africa","Egypt":"Africa",
    // Americas
    "United States":"Americas","Canada":"Americas","Mexico":"Americas","Brazil":"Americas","Chile":"Americas","Colombia":"Americas","Argentina":"Americas",
    // Asia
    "Japan":"Asia","South Korea":"Asia","Philippines":"Asia","Malaysia":"Asia","Thailand":"Asia","Indonesia":"Asia","Taiwan":"Asia","Turkey":"Asia","Israel":"Asia","Hong Kong":"Asia","Saudi Arabia":"Asia","United Arab Emirates":"Asia","Singapore":"Asia","India":"Asia","China":"Asia",
    // Europe
    "United Kingdom":"Europe","France":"Europe","Germany":"Europe","Italy":"Europe","Spain":"Europe","Netherlands":"Europe","Belgium":"Europe","Switzerland":"Europe","Austria":"Europe","Sweden":"Europe","Norway":"Europe","Denmark":"Europe","Finland":"Europe","Portugal":"Europe","Greece":"Europe","Poland":"Europe","Romania":"Europe","Bulgaria":"Europe","Slovakia":"Europe","Czechia":"Europe","Ukraine":"Europe","Russia":"Europe",
    // Oceania
    "Australia":"Oceania","New Zealand":"Oceania"
  };

  // Map color scale (green -> yellow -> red)
  const color = d3.scaleLinear()
    .domain([20, 50, 80]) // adjust for your distribution if needed
    .range(["#2ecc71", "#f1c40f", "#e74c3c"])
    .clamp(true);

  // Tooltip helpers
  const $tip = d3.select("#tooltip");
  let pinned = null;

  // Projection & path
  const svg = d3.select("#map");
  const width = 960, height = 520;
  const projection = d3.geoNaturalEarth1()
    .rotate([0,0])
    .fitExtent([[10,10],[width-10,height-10]], {type:"Sphere"});
  const path = d3.geoPath(projection);

  // Load world topology
  // (Robust, small 110m world from world-atlas)
  const world = await d3.json("https://unpkg.com/world-atlas@2/countries-110m.json");
  const countries = topojson.feature(world, world.objects.countries).features;

  // Name normalization to match CSV country names
  function normalizeName(n){
    return (n||"").replace("United States of America","United States")
      .replace("Russian Federation","Russia")
      .replace("Korea, Republic of","South Korea")
      .replace("Korea (South)","South Korea")
      .replace("Czech Republic","Czechia")
      .replace("Viet Nam","Vietnam")
      .replace("Hong Kong SAR China","Hong Kong")
      .replace("Iran, Islamic Republic of","Iran")
      .replace("Syrian Arab Republic","Syria")
      .replace("North Macedonia","Macedonia")
      .replace("Myanmar","Burma")
      .replace("Lao PDR","Laos")
      .replace("Türkiye","Turkey")
      .replace("UAE","United Arab Emirates")
      .replace("United Republic of Tanzania","Tanzania")
      .trim();
  }

  // Data load function
  async function loadData(srcUrl) {
    const text = await fetch(srcUrl, {cache:"no-store"}).then(r => {
      if (!r.ok) throw new Error("Failed to fetch CSV: " + r.status);
      return r.text();
    });
    const raw = d3.csvParse(text);

    // Cast numeric fields & attach region
    const data = raw.map(d => {
      const obj = {
        Country: d.Country?.trim(),
        Sleep_Hours: +d.Sleep_Hours,
        Screen_Hours: +d.Screen_Hours,
        Annual_Work_Hours: +d.Annual_Work_Hours,
        Tension: +d.Tension_Index_v1
      };
      obj.Region = REGION_BY_NAME[obj.Country] || "Unknown";
      return obj;
    }).filter(d => d.Country && isFinite(d.Tension));

    return data;
  }

  // Draw map and ranking
  async function draw(srcUrl) {
    let data;
    try {
      data = await loadData(srcUrl);
    } catch (err) {
      console.error(err);
      d3.select("#rankTitle").text("Error loading CSV");
      d3.select("#rankSubtitle").text(err.message);
      return;
    }

    // Index by country name
    const byName = new Map(data.map(d => [d.Country, d]));

    // Clear SVG
    svg.selectAll("*").remove();

    // Graticule
    const g = svg.append("g");
    g.append("path")
      .attr("d", path({type:"Sphere"}))
      .attr("fill", "#f4f8fb");

    // Countries
    const countryG = g.append("g");

    countryG.selectAll("path.country")
      .data(countries)
      .join("path")
      .attr("class","country")
      .attr("d", path)
      .attr("fill", d => {
        const cName = normalizeName(d.properties.name);
        const row = byName.get(cName);
        return row ? color(row.Tension) : "#ddd";
      })
      .attr("stroke", "#fff")
      .attr("stroke-width", 0.6)
      .on("mousemove", (event,d) => {
        if (pinned) return;
        const cName = normalizeName(d.properties.name);
        showTooltip(event, byName.get(cName), cName);
      })
      .on("mouseleave", () => {
        if (!pinned) hideTooltip();
      })
      .on("click", (event,d) => {
        const cName = normalizeName(d.properties.name);
        const row = byName.get(cName);
        if (pinned && pinned.name === cName) {
          pinned = null; hideTooltip();
        } else {
          pinned = {name: cName, row};
          showTooltip(event, row, cName, true);
        }
      });

    // Build ranking list (Top N & region filter)
    function refreshRanking() {
      const region = document.getElementById("regionSelect").value;
      const limit = +document.getElementById("countSelect").value;

      let rows = data.slice();
      if (region !== "All") {
        rows = rows.filter(d => d.Region === region);
      }
      rows.sort((a,b) => d3.descending(a.Tension, b.Tension));
      rows = rows.slice(0, limit);

      const maxScore = d3.max(rows, d => d.Tension) || 100;

      d3.select("#rankTitle").text(`Top ${limit} by Tension Index`);
      d3.select("#rankSubtitle").text(region === "All" ? "All regions" : region);

      const list = d3.select("#rankList");
      list.selectAll("*").remove();

      rows.forEach((r, i) => {
        const row = list.append("div").attr("class","row");
        row.append("div").html(`<strong>${i+1}. ${r.Country}</strong> <small>(${r.Tension.toFixed(1)})</small>`);
        const bar = row.append("div").attr("class","bar");
        bar.append("span")
          .style("width", `${(r.Tension/maxScore)*100}%`);
      });
    }

    refreshRanking();
    document.getElementById("regionSelect").addEventListener("change", refreshRanking);
    document.getElementById("countSelect").addEventListener("change", refreshRanking);
  }

  function showTooltip(event, row, name, pin=false) {
    const html = row ? `
      <div style="font-weight:700;margin-bottom:4px;">${name}</div>
      <div>Tension: <strong>${(row.Tension ?? 0).toFixed(1)}</strong> / 100</div>
      <div>Sleep: ${isFinite(row.Sleep_Hours)? row.Sleep_Hours.toFixed(1) : "–"} h</div>
      <div>Screen: ${isFinite(row.Screen_Hours)? row.Screen_Hours.toFixed(1) : "–"} h</div>
      <div>Work: ${isFinite(row.Annual_Work_Hours)? row.Annual_Work_Hours.toFixed(0) : "–"} hrs/yr</div>
    ` : `<div style="font-weight:700;margin-bottom:4px;">${name}</div><div>No data</div>`;

    $tip.html(html)
      .style("opacity", 1)
      .style("left", (event.clientX + 14) + "px")
      .style("top", (event.clientY + 14) + "px");
    if (pin) $tip.style("opacity", 1);
  }
  function hideTooltip(){ $tip.style("opacity", 0); }

  // Load on button or init
  document.getElementById("loadBtn").addEventListener("click", () => {
    const url = document.getElementById("csvInput").value.trim();
    draw(url);
  });

  // Auto-load on init
  if (csvInputEl.value && csvInputEl.value !== "https://cdn.shopify.com/s/files/1/0674/7278/5560/files/modern_tension_index_2025.csv") {
    draw(csvInputEl.value);
  } else {
    // If user passes ?csv= param, it already set; otherwise prompt to paste
    // You can call draw(CSV_URL) here if you hardcoded your URL above.
  }
})();
</script>
</body>
</html>

