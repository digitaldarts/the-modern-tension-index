<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modern Tension Index 2025 — World Map</title>
<script src="https://unpkg.com/d3@7"></script>
<script src="https://unpkg.com/topojson@3"></script>
<style>
  body {
    font-family: system-ui, sans-serif;
    background: #fff;
    margin: 0;
  }
  svg {
    width: 100%;
    height: 800px;
    display: block;
  }
  .tooltip {
    position: absolute;
    background: rgba(0,0,0,0.75);
    color: #fff;
    padding: 6px 10px;
    border-radius: 4px;
    pointer-events: none;
    font-size: 13px;
    line-height: 1.4;
  }
  .legend {
    font-size: 13px;
    fill: #333;
  }
</style>
</head>
<body>
<svg></svg>
<div class="tooltip" style="opacity:0;"></div>

<script>
(async function() {
  const csvUrl = "https://raw.githubusercontent.com/digitaldarts/the-modern-tension-index/main/modern_tension_index_2025.csv";
  const worldUrl = "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json";

  const svg = d3.select("svg");
  const tooltip = d3.select(".tooltip");
  const width = svg.node().clientWidth;
  const height = svg.node().clientHeight;

  const projection = d3.geoNaturalEarth1().scale(width / 1.3 / Math.PI).translate([width / 2, height / 2]);
  const path = d3.geoPath(projection);

  const color = d3.scaleSequential()
    .domain([0, 100])
    .interpolator(d3.interpolateRdYlBu.reverse());

  // Load data
  const [world, csv] = await Promise.all([
    d3.json(worldUrl),
    d3.csv(csvUrl, d => ({
      country: d.Country,
      tension: +d.Tension_Index_v1 || 0,
      sleep: +d.Sleep_Hours || null,
      screen: +d.Screen_Hours || null,
      work: +d.Annual_Work_Hours || null
    }))
  ]);

  const dataMap = new Map(csv.map(d => [d.country.toLowerCase(), d]));

  const countries = topojson.feature(world, world.objects.countries).features;

  const g = svg.append("g");

  g.selectAll("path")
    .data(countries)
    .join("path")
    .attr("d", path)
    .attr("fill", d => {
      const match = dataMap.get(d.properties.name.toLowerCase());
      return match ? color(match.tension) : "#eee";
    })
    .attr("stroke", "#ccc")
    .attr("stroke-width", 0.5)
    .on("mousemove", (event, d) => {
      const match = dataMap.get(d.properties.name.toLowerCase());
      if (match) {
        tooltip
          .style("opacity", 1)
          .html(`
            <strong>${d.properties.name}</strong><br>
            Tension Index: ${match.tension.toFixed(1)} / 100<br>
            Sleep: ${match.sleep ? match.sleep.toFixed(1) + " h" : "–"}<br>
            Screen: ${match.screen ? match.screen.toFixed(1) + " h" : "–"}<br>
            Work: ${match.work ? Math.round(match.work) + " hrs/yr" : "–"}
          `)
          .style("left", (event.pageX + 12) + "px")
          .style("top", (event.pageY - 28) + "px");
      }
    })
    .on("mouseout", () => tooltip.style("opacity", 0));

  // Zoom and pan
  const zoom = d3.zoom()
    .scaleExtent([1, 8])
    .on("zoom", (event) => g.attr("transform", event.transform));

  svg.call(zoom);

  // Legend
  const legendWidth = 240, legendHeight = 10;
  const legendSvg = svg.append("g")
    .attr("transform", `translate(${width - legendWidth - 40},${height - 40})`);

  const legendScale = d3.scaleLinear()
    .domain(color.domain())
    .range([0, legendWidth]);

  const legendAxis = d3.axisBottom(legendScale)
    .ticks(5)
    .tickFormat(d => d);

  const legendGradient = legendSvg.append("defs")
    .append("linearGradient")
    .attr("id", "legend-gradient")
    .attr("x1", "0%")
    .attr("x2", "100%")
    .selectAll("stop")
    .data(d3.ticks(0, 1, 10))
    .join("stop")
    .attr("offset", d => `${d * 100}%`)
    .attr("stop-color", d => color(d * 100));

  legendSvg.append("rect")
    .attr("width", legendWidth)
    .attr("height", legendHeight)
    .style("fill", "url(#legend-gradient)");

  legendSvg.append("g")
    .attr("transform", `translate(0,${legendHeight})`)
    .call(legendAxis)
    .call(g => g.select(".domain").remove());

  legendSvg.append("text")
    .attr("x", legendWidth / 2)
    .attr("y", -8)
    .attr("text-anchor", "middle")
    .attr("font-size", "12px")
    .text("Modern Tension Index (0 = relaxed, 100 = tense)");
})();
</script>
</body>
</html>
