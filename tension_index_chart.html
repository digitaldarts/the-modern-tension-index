<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Modern Tension Index 2025 — World Map</title>
<script src="https://unpkg.com/d3@7"></script>
<script src="https://unpkg.com/topojson@3"></script>
<style>
  html, body { margin:0; background:#fff; font-family:system-ui,sans-serif; }
  svg { width:100%; height:820px; display:block; }
  .tooltip {
    position:absolute; background:rgba(0,0,0,0.75); color:#fff;
    padding:6px 10px; border-radius:4px; font-size:13px;
    pointer-events:none; opacity:0; transition:opacity .1s;
  }
</style>
</head>
<body>
<svg></svg>
<div class="tooltip"></div>

<script>
(async function() {
  const CSV_URL = "https://raw.githubusercontent.com/digitaldarts/the-modern-tension-index/main/modern_tension_index_2025.csv";
  const WORLD_URL = "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json";

  const svg = d3.select("svg");
  const tooltip = d3.select(".tooltip");
  const width = svg.node().clientWidth;
  const height = svg.node().clientHeight;

  const projection = d3.geoNaturalEarth1()
    .scale(width / 1.3 / Math.PI)
    .translate([width / 2, height / 2]);

  const path = d3.geoPath(projection);
  const color = d3.scaleSequential()
    .domain([0, 100])
    .interpolator(d3.interpolateRdYlBu.reverse());

  // Load data
  const [world, data] = await Promise.all([
    d3.json(WORLD_URL),
    d3.csv(CSV_URL, d => ({
      country: d.Country.trim(),
      tension: +d.Tension_Index_v1,
      sleep: +d.Sleep_Hours,
      screen: +d.Screen_Hours,
      work: +d.Annual_Work_Hours
    }))
  ]);

  const dataMap = new Map(data.map(d => [d.country.toLowerCase(), d]));
  const countries = topojson.feature(world, world.objects.countries).features;

  const g = svg.append("g");

  g.selectAll("path")
    .data(countries)
    .join("path")
    .attr("d", path)
    .attr("fill", d => {
      const name = d.properties.name.toLowerCase();
      const match = dataMap.get(name);
      return match ? color(match.tension) : "#eee";
    })
    .attr("stroke", "#ccc")
    .attr("stroke-width", 0.5)
    .on("mousemove", (event, d) => {
      const name = d.properties.name.toLowerCase();
      const match = dataMap.get(name);
      if (!match) return tooltip.style("opacity", 0);
      tooltip
        .style("opacity", 1)
        .html(`
          <strong>${d.properties.name}</strong><br>
          Tension Index: ${match.tension.toFixed(1)} / 100<br>
          Sleep: ${match.sleep ? match.sleep.toFixed(1) + " h" : "–"}<br>
          Screen: ${match.screen ? match.screen.toFixed(1) + " h" : "–"}<br>
          Work: ${match.work ? Math.round(match.work) + " hrs/yr" : "–"}
        `)
        .style("left", (event.pageX + 12) + "px")
        .style("top", (event.pageY - 28) + "px");
    })
    .on("mouseout", () => tooltip.style("opacity", 0));

  svg.call(
    d3.zoom().scaleExtent([1, 8])
      .on("zoom", e => g.attr("transform", e.transform))
  );

})();
</script>
</body>
</html>
